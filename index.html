<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Happy Birthday ‚Äî Insert Your Name</title>
<style>
  /* Mobile-first, playful palette */
  :root{
    --bg:#FFF6FF;
    --card:#ffffff;
    --accent1:#ff5aa5;
    --accent2:#6ec6ff;
    --accent3:#ffd166;
    --accent4:#a17bff;
    --text:#222;
    --glass: rgba(255,255,255,0.7);
    --shadow: 0 6px 20px rgba(0,0,0,0.12);
    --safe-margin: 16px;
    --radius:18px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{
    background: linear-gradient(160deg, #fff0f8 0%, #f0f8ff 50%, #fffaf0 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }

  /* App container */
  .app{
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:12px;
    padding: calc(var(--safe-margin) + 8px);
    box-sizing:border-box;
    position:relative;
  }

  /* Header area */
  header{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .logo{
    display:flex;align-items:center;gap:8px;
    font-weight:700;
  }
  .logo .dot{width:12px;height:12px;border-radius:50%;background:var(--accent1);box-shadow:0 4px 10px rgba(0,0,0,0.12)}
  .nav-btn{
    background:var(--card);border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);font-weight:600;border:none;
  }

  /* Pages (sections) */
  .page{width:100%;height:calc(100vh - 110px);background:transparent;border-radius:12px;display:none;flex-direction:column;align-items:center;overflow:auto;padding:12px 0;}
  .page.active{display:flex}

  /* Hero */
  .hero{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    padding-top:12px;
  }
  .greeting{
    font-size:28px; text-align:center; font-weight:800; letter-spacing:0.6px;
    padding:18px 12px;border-radius:14px;background:linear-gradient(90deg,var(--accent2),var(--accent4));
    color:white;box-shadow:0 12px 30px rgba(0,0,0,0.12);width:100%;
    animation: glow 3000ms infinite alternate;
  }
  @keyframes glow{
    from{filter:drop-shadow(0 6px 18px rgba(161,123,255,0.18))}
    to{filter:drop-shadow(0 14px 28px rgba(255,90,165,0.18))}
  }

  .small{
    font-size:14px;color:#444;margin-top:4px;text-align:center;
  }

  .big-btn{
    margin-top:12px;
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:white;padding:14px 18px;border-radius:14px;border:none;font-weight:800;font-size:16px;box-shadow:var(--shadow);
    width:85%;
  }
  .secondary{
    background:linear-gradient(90deg,var(--card),#fff);color:var(--accent2);border:2px solid rgba(0,0,0,0.04)
  }

  /* floating balloons container */
  #balloon-layer{position:absolute;left:0;right:0;top:0;height:100vh;pointer-events:none;overflow:hidden;z-index:1}

  /* mascot and audio */
  .mascot{
    width:84px;height:84px;border-radius:18px;background:linear-gradient(180deg,#fff 0%,#fff5f0 100%);display:flex;align-items:center;
    justify-content:center;box-shadow:var(--shadow);font-size:40px;
  }
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;justify-content:center}

  /* games area */
  .games{width:100%;display:flex;flex-direction:column;gap:12px;align-items:center}
  .game-card{width:90%;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;align-items:center}
  .game-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:100%}
  .balloon{width:62px;height:84px;border-radius:60px 60px 20px 20px;display:flex;align-items:center;justify-content:center;font-size:20px;color:white;position:relative;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.12)}
  .balloon::after{content:'';width:2px;height:20px;background:#333;position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);border-radius:2px;opacity:0.6}

  /* gift box */
  .gift{width:64px;height:64px;background:linear-gradient(180deg,#ffefef,#ffd6f0);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px;cursor:pointer}
  .gift .ribbon{position:absolute;width:18px;height:18px;border-radius:6px;background:var(--accent1);transform:rotate(45deg);top:6px}

  /* memory card */
  .card{width:70px;height:70px;border-radius:12px;background:#f7f7f7;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .card.flipped{background:linear-gradient(90deg,var(--accent2),var(--accent4));color:white}

  /* message input */
  .message-container{width:90%;display:flex;flex-direction:column;gap:8px}
  textarea{width:100%;min-height:90px;border-radius:10px;padding:10px;border:none;box-shadow:var(--shadow);resize:none}
  .messages-list{width:100%;max-height:160px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fff);box-shadow:0 6px 12px rgba(0,0,0,0.06)}
  .msg{padding:8px;border-radius:8px;background:linear-gradient(90deg,#fff,#fff7);margin-bottom:8px;font-size:14px}

  /* final cake */
  .cake-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
  .cake{
    width:220px;height:160px;background:linear-gradient(180deg,#ffcfdf,#ff9fbf);
    border-radius:16px 16px 40px 40px;position:relative;box-shadow:0 20px 40px rgba(0,0,0,0.12);
    display:flex;align-items:center;justify-content:center;flex-direction:column;padding-top:28px;
  }
  .candles{display:flex;gap:8px;position:absolute;top:-22px}
  .candle{width:10px;height:32px;background:#fff;border-radius:3px;position:relative;display:flex;align-items:flex-start;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.08)}
  .flame{width:8px;height:12px;background:orange;border-radius:50%;position:absolute;top:-10px;box-shadow:0 6px 10px rgba(255,165,0,0.3)}
  .cake-sprinkle{width:8px;height:8px;border-radius:50%;position:absolute;left:12%;top:40%}
  .blown .flame{opacity:0;transform:translateY(-8px);transition:all 700ms cubic-bezier(.2,.9,.3,1)}

  /* fireworks canvas overlay */
  canvas#confetti-canvas{position:fixed;left:0;top:0;pointer-events:none;z-index:50}

  footer{position:relative;width:100%;display:flex;justify-content:center;gap:8px;margin-bottom:6px}
  .small-muted{font-size:12px;color:#555}

  /* responsive tweaks */
  @media(min-width:420px){
    .greeting{font-size:32px}
    .cake{width:320px;height:220px}
  }

</style>
</head>
<body>
<div id="balloon-layer"></div>
<canvas id="confetti-canvas"></canvas>

<div class="app" role="application" aria-label="Birthday app">
  <header>
    <div class="logo" aria-hidden="true"><span class="dot"></span><span>Birthday Fun</span></div>
    <div>
      <button class="nav-btn" id="home-btn">Home</button>
      <button class="nav-btn" id="voice-btn">Voice</button>
      <button class="nav-btn" id="games-btn">Games</button>
      <button class="nav-btn" id="final-btn">Final</button>
    </div>
  </header>

  <!-- Home Page -->
  <section id="home" class="page active" aria-labelledby="homeTitle">
    <div class="hero" role="region">
      <div class="greeting" id="homeTitle">Happy Birthday ‚Äî Insert your name!</div>
      <div class="small">Enter the name below ‚Äî the site will say it and use it across pages.</div>

      <div style="width:90%;display:flex;gap:8px;justify-content:center;align-items:center;margin-top:8px">
        <input id="nameInput" type="text" placeholder="Insert your name" style="flex:1;padding:12px;border-radius:12px;border:none;box-shadow:var(--shadow);font-weight:700" />
        <button class="big-btn secondary" id="saveNameBtn" style="padding:12px 16px">Save</button>
      </div>

      <button class="big-btn" id="surpriseBtn" style="width:90%">Click for a Surprise üéâ</button>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <div class="mascot" id="homeMascot">üéÇ</div>
        <div style="text-align:left">
          <div style="font-weight:700">Party Mode</div>
          <div style="font-size:13px;color:#444">Music, confetti & floating balloons ‚Äî tap anywhere to pop a confetti burst.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Voice Wishes Page -->
  <section id="voice" class="page" aria-labelledby="voiceTitle">
    <div class="hero" style="padding-top:6px">
      <div style="display:flex;gap:10px;align-items:center;width:90%;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="mascot" id="voiceMascot">üó£Ô∏è</div>
          <div>
            <div id="voiceTitle" style="font-weight:800;font-size:18px">Voice Wishes</div>
            <div style="font-size:13px;color:#555">Default cheerful wish or upload your own (MP3/WAV).</div>
          </div>
        </div>
        <div id="wave" style="font-size:12px;color:#666">Status: idle</div>
      </div>

      <div class="controls">
        <button class="big-btn" id="playDefault">Play Default Wish</button>
        <button class="big-btn secondary" id="recordBtn">Use Mic Blow (Final page only)</button>
      </div>

      <div style="width:90%;display:flex;gap:8px;margin-top:12px;align-items:center;flex-direction:column">
        <input type="file" id="uploadAudio" accept="audio/*" style="width:100%"/>
        <audio id="uploadedAudio" controls style="width:100%;display:none"></audio>
        <div style="font-size:13px;color:#444;text-align:center;margin-top:6px">Upload an MP3/WAV from phone‚Äîthen press play to hear it with our mascot animation.</div>
      </div>
    </div>
  </section>

  <!-- Games Page -->
  <section id="games" class="page" aria-labelledby="gamesTitle">
    <div style="width:100%;display:flex;flex-direction:column;align-items:center;gap:12px;padding-top:6px">
      <div style="width:90%;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Fun Games</div>
        <div style="font-size:12px;color:#666">Tap fast ‚Äî mobile-friendly!</div>
      </div>

      <!-- Balloon Pop Game -->
      <div class="game-card">
        <div style="font-weight:700">üéà Balloon Pop</div>
        <div id="balloonGame" style="width:100%;height:180px;position:relative;overflow:hidden;border-radius:12px"></div>
        <div style="font-size:13px;color:#444">Pop balloons to reveal little wishes.</div>
      </div>

      <!-- Gift Boxes -->
      <div class="game-card">
        <div style="font-weight:700">üéÅ Gift Box Surprise</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;width:100%">
          <div class="gift" data-idx="0">üéÅ</div>
          <div class="gift" data-idx="1">üéÅ</div>
          <div class="gift" data-idx="2">üéÅ</div>
        </div>
        <div id="giftReveal" style="margin-top:8px;font-size:14px;color:#333"></div>
      </div>

      <!-- Memory Match -->
      <div class="game-card">
        <div style="font-weight:700">üß† Memory Match</div>
        <div id="memoryGrid" class="game-grid" style="margin-top:8px"></div>
        <div style="font-size:13px;color:#444;margin-top:6px">Match pairs of birthday icons!</div>
      </div>

      <!-- Messages -->
      <div class="game-card message-container">
        <div style="font-weight:700">üíå Leave a message</div>
        <textarea id="msgInput" placeholder="Write a wish..."></textarea>
        <div style="display:flex;gap:8px;justify-content:space-between">
          <button class="big-btn" id="saveMsg">Save Message</button>
          <button class="nav-btn" id="clearMsgs">Clear</button>
        </div>
        <div class="messages-list" id="messagesList" aria-live="polite"></div>
      </div>
    </div>
  </section>

  <!-- Final Surprise Page -->
  <section id="final" class="page" aria-labelledby="finalTitle">
    <div class="hero" style="padding-top:8px">
      <div style="width:90%;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px" id="finalTitle">Final Surprise</div>
        <div style="font-size:12px;color:#666">Blow out the candles!</div>
      </div>

      <div class="cake-wrap" style="margin-top:12px">
        <div id="cake" class="cake" role="img" aria-label="Birthday Cake">
          <div class="candles" id="candles">
            <div class="candle"><div class="flame"></div></div>
            <div class="candle"><div class="flame"></div></div>
            <div class="candle"><div class="flame"></div></div>
            <div class="candle"><div class="flame"></div></div>
          </div>
          <div style="font-weight:800;color:white;font-size:18px">Happy Birthday!</div>
        </div>

        <div style="width:90%;display:flex;gap:8px;justify-content:center;align-items:center">
          <button class="big-btn" id="blowBtn">Click to Blow Out üïØÔ∏è</button>
          <button class="big-btn secondary" id="micBlowBtn">Blow into Mic</button>
        </div>

        <div style="font-size:13px;color:#444;text-align:center;margin-top:6px">Candles will animate out and a final song will play.</div>
      </div>
    </div>
  </section>

  <footer><div class="small-muted">Made with üéâ ‚Äî Mobile-first</div></footer>
</div>

<script>
/* ===========================
   Utility: small helpers
   =========================== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
function ease(t){return (--t)*t*t+1}

/* Confetti canvas */
const confettiCanvas = $('#confetti-canvas');
confettiCanvas.width = innerWidth;
confettiCanvas.height = innerHeight;
const confCtx = confettiCanvas.getContext('2d');
let confettiPieces = [];
function spawnConfetti(x=innerWidth/2,y=innerHeight/2,amount=30){
  for(let i=0;i<amount;i++){
    confettiPieces.push({
      x, y,
      vx: (Math.random()-0.5)*6,
      vy: Math.random()*-6 - 1,
      r: Math.random()*6+4,
      c: ['#ff5aa5','#6ec6ff','#ffd166','#a17bff'][Math.floor(Math.random()*4)],
      life: 80 + Math.random()*40
    });
  }
}
function confettiLoop(){
  confCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confettiPieces.forEach((p,i)=>{
    p.vy += 0.25;
    p.x += p.vx;
    p.y += p.vy;
    p.life--;
    confCtx.fillStyle = p.c;
    confCtx.beginPath();
    confCtx.ellipse(p.x,p.y,p.r, p.r*0.6, 0,0,Math.PI*2);
    confCtx.fill();
    if(p.life<=0 || p.y>confettiCanvas.height+50) confettiPieces.splice(i,1);
  });
  requestAnimationFrame(confettiLoop);
}
confettiLoop();

/* Floating balloon background generator */
const balloonLayer = $('#balloon-layer');
function makeFloatingBalloon(color, leftPct, delay){
  const el = document.createElement('div');
  el.className='balloon';
  el.style.background = `linear-gradient(180deg, ${color}, ${shade(color,-12)})`;
  el.style.position='absolute';
  el.style.left = leftPct + '%';
  el.style.bottom = '-160px';
  el.style.transform = `translateY(0)`;
  el.style.pointerEvents='none';
  el.style.opacity=0.95;
  balloonLayer.appendChild(el);
  // animate up with random sway
  const dur = 14000 + Math.random()*10000;
  el.animate([
    {transform:'translateY(0) translateX(0) rotate(0deg)'},
    {transform:`translateY(-120vh) translateX(${(Math.random()*80-40)}px) rotate(${(Math.random()*30-15)}deg)`}
  ],{duration:dur, delay, iterations:1, easing:'cubic-bezier(.2,.8,.2,1)'});
  setTimeout(()=>el.remove(), dur+delay+200);
}
function shade(hex, percent){
  // expects #rrggbb
  const n=parseInt(hex.slice(1),16), r=(n>>16), g=(n>>8&255), b=(n&255);
  const t=percent<0?0:255; const p=Math.abs(percent)/100;
  const R=Math.round((t-r)*p)+r,G=Math.round((t-g)*p)+g,B=Math.round((t-b)*p)+b;
  return '#'+(1<<24|R<<16|G<<8|B).toString(16).slice(1);
}
// spawn random background balloons occasionally
setInterval(()=> {
  makeFloatingBalloon(['#ff5aa5','#6ec6ff','#ffd166','#a17bff'][Math.floor(Math.random()*4)], Math.random()*100, 0);
}, 2500);

/* Click for confetti burst on body taps */
document.body.addEventListener('click', (e)=>{
  spawnConfetti(e.clientX, e.clientY, 18);
});

/* ===========================
   SPA Navigation
   =========================== */
const pages = {home:$('#home'), voice:$('#voice'), games:$('#games'), final:$('#final')};
function showPage(name){
  Object.keys(pages).forEach(k=>pages[k].classList.remove('active'));
  pages[name].classList.add('active');
}
$('#home-btn').onclick = ()=>showPage('home');
$('#voice-btn').onclick = ()=>showPage('voice');
$('#games-btn').onclick = ()=>showPage('games');
$('#final-btn').onclick = ()=>showPage('final');

/* ===========================
   Name input & global usage
   =========================== */
let nameKey = 'birthday_name_v1';
function setName(n){
  n = (n || '').trim() || 'Friend';
  localStorage.setItem(nameKey, n);
  updateNameUI();
}
function getName(){ return localStorage.getItem(nameKey) || 'Friend' }
function updateNameUI(){
  const n = getName();
  $('.greeting').textContent = `Happy Birthday ‚Äî ${n}!`;
  $('#homeTitle').textContent = `Happy Birthday ‚Äî ${n}!`;
  $('#finalTitle').textContent = `Final Surprise for ${n}`;
}
$('#saveNameBtn').onclick = ()=>{ setName($('#nameInput').value); spawnConfetti(innerWidth/2, innerHeight/2, 30); }
$('#nameInput').addEventListener('keyup', (e)=>{ if(e.key==='Enter') setName(e.target.value); });
setName(localStorage.getItem(nameKey) || 'Friend');

/* ===========================
   Simple background melody
   (WebAudio, small sequence)
   =========================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playMelody(){
  const now = audioCtx.currentTime;
  const notes = [523.25,659.25,783.99,659.25]; // C5,E5,G5,E5
  let t = 0;
  notes.forEach((f, i) => {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = f;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(now+t);
    g.gain.exponentialRampToValueAtTime(0.12, now+t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+t+0.35);
    o.stop(now+t+0.4);
    t += 0.35;
  });
}

/* play a loop when user taps Surprise */
$('#surpriseBtn').onclick = async ()=>{
  showPage('voice');
  spawnConfetti(innerWidth/2, innerHeight/2, 50);
  playMelody();
  // also animate mascot
  const m = $('#homeMascot');
  m.animate([{transform:'scale(1)'},{transform:'scale(1.16)'},{transform:'scale(1)'}],{duration:900, iterations:1, easing:'ease-in-out'});
};

/* ===========================
   Voice Wishes page
   - default TTS
   - upload audio play
   - mascot animation while speaking
   =========================== */
const voiceMascot = $('#voiceMascot');
const voiceStatus = $('#wave');

function speakText(text, opts={}){
  if(!('speechSynthesis' in window)) return alert('SpeechSynthesis not supported on this browser.');
  const ut = new SpeechSynthesisUtterance(text);
  ut.rate = opts.rate || 1;
  ut.pitch = opts.pitch || 1.1;
  ut.lang = opts.lang || 'en-US';
  ut.onstart = ()=>{voiceStatus.textContent='Status: speaking'; animateMascot(true);}
  ut.onend = ()=>{voiceStatus.textContent='Status: idle'; animateMascot(false)}
  speechSynthesis.cancel();
  speechSynthesis.speak(ut);
}

function animateMascot(speaking){
  if(speaking){
    voiceMascot.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:400,iterations:Infinity,easing:'ease-in-out'});
  } else {
    voiceMascot.getAnimations().forEach(a=>a.cancel());
  }
}

$('#playDefault').onclick = ()=>{
  const n = getName();
  speakText(`Happy Birthday ${n}! Wishing you a fantastic day full of cake and smiles!`, {rate:1,pitch:1.2});
};

/* File upload play */
const uploadedAudio = $('#uploadedAudio');
$('#uploadAudio').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  uploadedAudio.src = url;
  uploadedAudio.style.display='block';
  uploadedAudio.play();
  animateMascot(true);
  uploadedAudio.onended = ()=> animateMascot(false);
});

/* ===========================
   Balloon Pop Game
   =========================== */
const balloonGame = $('#balloonGame');
const balloonMessages = [
  "Have a blast!",
  "Cake time üéÇ",
  "Make a wish!",
  "Party on!",
  "Hugs ü§ó",
  "Surprise!"
];
function spawnGameBalloon(){
  const el = document.createElement('div');
  el.className='balloon';
  el.style.left = (10 + Math.random()*80) + '%';
  el.style.bottom = '-90px';
  el.style.background = ['#ff5aa5','#6ec6ff','#ffd166','#a17bff'][Math.floor(Math.random()*4)];
  el.style.position='absolute';
  el.style.width = `${56 + Math.random()*30}px`;
  el.style.height = `${76 + Math.random()*30}px`;
  el.style.fontSize = '15px';
  el.textContent = 'üéà';
  balloonGame.appendChild(el);
  // float up
  const dur = 6000 + Math.random()*5000;
  const anim = el.animate([{transform:'translateY(0)'},{transform:`translateY(-320px)`}],{duration:dur, easing:'linear'});
  // attach click to pop
  el.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    const idx = Math.floor(Math.random()*balloonMessages.length);
    const msg = balloonMessages[idx];
    popEffect(el);
    showTempMessage(msg);
    spawnConfetti(ev.clientX, ev.clientY, 14);
  });
  setTimeout(()=>{ if(el.parentNode) el.remove();}, dur+2000);
}
function popEffect(el){
  el.style.transition='transform .2s ease, opacity .2s ease';
  el.style.transform='scale(0.2) rotate(20deg)';
  el.style.opacity='0';
  setTimeout(()=>el.remove(),220);
}
function showTempMessage(text){
  const d = document.createElement('div');
  d.className='msg'; d.textContent=text;
  d.style.position='absolute'; d.style.bottom='10px'; d.style.left='50%';
  d.style.transform='translateX(-50%)'; d.style.zIndex=10;
  balloonGame.appendChild(d);
  setTimeout(()=>d.remove(),2200);
}
// spawn continuous for game area
let balloonGameInterval = setInterval(spawnGameBalloon, 900);

/* ===========================
   Gift boxes logic
   =========================== */
const gifts = $$('.gift');
const giftReveal = $('#giftReveal');
const giftContents = [
  "Joke: Why did the candle get fired? It couldn't hold a flame!",
  "Look behind you ‚Äî a virtual hug! ü§ó",
  "Here's a secret: you are amazing!"
];
gifts.forEach(g=>{
  g.addEventListener('click', (e)=>{
    const idx = parseInt(g.dataset.idx,10) || 0;
    giftReveal.textContent = giftContents[idx % giftContents.length];
    spawnConfetti(e.clientX, e.clientY, 16);
    g.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:500,iterations:1});
  });
});

/* ===========================
   Memory Match Game
   =========================== */
const icons = ['üéÇ','üéâ','üéà','üïØÔ∏è','üéÅ','ü•≥','üç∞','üéµ'];
let memoryState = {first:null, second:null, pairsFound:0};
function initMemory(){
  const grid = $('#memoryGrid');
  grid.innerHTML='';
  const pairs = icons.slice(0,6); // choose 6 pairs for 12 cards
  const deck = shuffle([...pairs, ...pairs]);
  deck.forEach((icon, idx)=>{
    const card = document.createElement('div');
    card.className='card';
    card.dataset.icon = icon;
    card.dataset.idx = idx;
    card.textContent = '';
    card.addEventListener('click', ()=>flipCard(card));
    grid.appendChild(card);
  });
}
function flipCard(card){
  if(card.classList.contains('flipped') || memoryState.second) return;
  card.classList.add('flipped');
  card.textContent = card.dataset.icon;
  if(!memoryState.first){ memoryState.first = card; return; }
  memoryState.second = card;
  // check match
  if(memoryState.first.dataset.icon === memoryState.second.dataset.icon){
    memoryState.pairsFound++;
    spawnConfetti(card.getBoundingClientRect().left + 20, card.getBoundingClientRect().top + 20, 12);
    memoryState.first.style.pointerEvents='none';
    memoryState.second.style.pointerEvents='none';
    memoryState.first = memoryState.second = null;
    if(memoryState.pairsFound >= 6){
      setTimeout(()=>{ alert('You found them all! üéâ'); initMemory(); memoryState.pairsFound=0; }, 400);
    }
  } else {
    setTimeout(()=>{ memoryState.first.classList.remove('flipped'); memoryState.first.textContent=''; memoryState.second.classList.remove('flipped'); memoryState.second.textContent=''; memoryState.first=null; memoryState.second=null; }, 800);
  }
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
initMemory();

/* ===========================
   Messages save/load
   =========================== */
const messagesKey = 'birthday_messages_v1';
function saveMessage(text){
  if(!text.trim()) return;
  const arr = JSON.parse(localStorage.getItem(messagesKey) || '[]');
  arr.unshift({text, time:Date.now()});
  localStorage.setItem(messagesKey, JSON.stringify(arr));
  renderMessages();
  spawnConfetti(innerWidth/2, innerHeight/2, 22);
}
function renderMessages(){
  const arr = JSON.parse(localStorage.getItem(messagesKey) || '[]');
  const el = $('#messagesList'); el.innerHTML='';
  arr.forEach(m=>{
    const d = document.createElement('div'); d.className='msg';
    const t = new Date(m.time).toLocaleString();
    d.innerHTML = `<div style="font-weight:700">${m.text}</div><div style="font-size:12px;color:#555">${t}</div>`;
    el.appendChild(d);
  });
}
$('#saveMsg').onclick = ()=>{ saveMessage($('#msgInput').value); $('#msgInput').value=''; }
$('#clearMsgs').onclick = ()=>{ localStorage.removeItem(messagesKey); renderMessages(); }
renderMessages();

/* ===========================
   Final Cake: blow out click & mic detection
   =========================== */
const cake = $('#cake');
const candles = $('#candles');
const blowBtn = $('#blowBtn');
const micBlowBtn = $('#micBlowBtn');

function blowOut(){
  cake.classList.add('blown');
  spawnConfetti(innerWidth/2, innerHeight/2, 80);
  playFinalSong();
  setTimeout(()=> cake.classList.remove('blown'), 5000);
}
blowBtn.onclick = ()=> blowOut();

/* Mic blow detection: measure microphone volume */
let mediaStream, analyser, dataArray, listening=false;
async function startMicDetect(){
  if(listening) return;
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const source = ctx.createMediaStreamSource(mediaStream);
    analyser = ctx.createAnalyser(); analyser.fftSize = 256;
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    listening = true;
    micBlowBtn.textContent = 'Listening... Blow!';
    detectLoudness();
  }catch(e){ alert('Microphone access denied or not available.'); console.warn(e) }
}
function stopMicDetect(){ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null } listening=false; micBlowBtn.textContent='Blow into Mic'; }
function detectLoudness(){
  if(!listening || !analyser) return;
  analyser.getByteTimeDomainData(dataArray);
  // compute amplitude
  let sum=0; for(let i=0;i<dataArray.length;i++){ const v=(dataArray[i]-128)/128; sum += v*v; }
  const rms = Math.sqrt(sum/dataArray.length);
  // console.log(rms);
  // threshold tuned for mobile mouth-blow (~0.09)
  if(rms > 0.11){
    // success: blow detected
    stopMicDetect();
    blowOut();
  } else {
    requestAnimationFrame(detectLoudness);
  }
}
micBlowBtn.addEventListener('click', ()=>{
  if(!listening) startMicDetect(); else stopMicDetect();
});

/* Final song: speak + melody */
function playFinalSong(){
  const n = getName();
  speakText(`Make a wish ${n}! Happy Birthday!`, {rate:0.95, pitch:1.2});
  // play short melody after small delay
  setTimeout(()=>{ playMelody(); setTimeout(()=> playMelody(), 450); }, 900);
}

/* ===========================
   Small decorations & start-up
   =========================== */
updateNameUI();
window.addEventListener('resize', ()=>{ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; });

/* small utility: prevent autoplay issues by resuming audio context on first interaction */
function resumeAudioContext(){
  if(audioCtx.state === 'suspended') audioCtx.resume();
  document.removeEventListener('touchstart', resumeAudioContext);
}
document.addEventListener('touchstart', resumeAudioContext);

/* Helpful small seed confetti on load */
window.addEventListener('load', ()=>{ spawnConfetti(innerWidth/2, innerHeight/3, 26); });

/* Accessibility: keyboard nav for testing on desktop */
document.addEventListener('keydown', (e)=>{
  if(e.key === '1') showPage('home');
  if(e.key === '2') showPage('voice');
  if(e.key === '3') showPage('games');
  if(e.key === '4') showPage('final');
});

</script>
</body>
</html>
